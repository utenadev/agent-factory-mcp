# 2026年1月26日 開発日誌 - 堅牢な城壁を築く日

## 今日のハイライト

今日は `agent-factory-mcp` にとって、プロトタイプからプロダクションレベルのソフトウェアへと脱皮するための重要な一日だった。

朝一番で取り組んだのは **「テスト戦略の刷新」**。
これまで「なんとなく」動いていたテストを、決定論的なユニットテストと、実環境依存のE2Eテストに明確に分離した。これにより、CI環境での不安定さを排除しつつ、実際のAIツールとの連携も保証できる「ハイブリッド構成」が完成した。

そして午後からは **「セキュリティ強化」**。
Devin と Claude からの鋭い指摘により、我々のコードベースに潜んでいた脆弱性が明らかになった。特に `autoDiscovery.ts` における `execSync` の使用は、便利な反面、コマンドインジェクションの温床になり得るものだった。これを `spawn` ベースに書き換え、さらに厳格なバリデーションと監査ログ（Audit Logger）を導入することで、堅牢な城壁を築くことができた。

## 技術的な振り返り

### 1. `execSync` の誘惑と罠
CLIツールを作る際、`execSync` は非常に便利だ。同期的に結果が返ってくるため、コードが直線的で読みやすくなる。しかし、セキュリティの観点からは悪夢だ。シェルを経由するため、入力値のサニタイズが甘ければ即座にインジェクション攻撃を許してしまう。今回、Claude が即座にこれを見抜き、修正を提案してくれたのは素晴らしい連携だった。

### 2. Bun vs Node.js の互換性
私たちは開発速度を求めて Bun を採用したが、それが仇となって Node.js ユーザーを排除しかけていた。「`npx` で動かないCLIツール」は、JavaScriptエコシステムにおいては存在しないも同然だ。
Phase 1.5 で Vitest への移行を決断したのは英断だったと思う。これで開発体験（Bun）とユーザー体験（Node.js互換）の両立が可能になる。

## AI エージェント同士の協奏

今日は特に、複数のAIエージェントがそれぞれの得意分野を活かしてプロジェクトを推進する様を目の当たりにした。

*   **MistralVibe**: 現状のテストカバレッジを冷静に分析し、欠落している部分（BaseCliProvider等）を指摘した。
*   **Devin**: プロジェクト全体を俯瞰し、セキュリティとアーキテクチャの欠陥を構造的に批判した。
*   **Claude Code**: 具体的な実装力に優れ、指摘された脆弱性を驚くべき速さで修正コードに落とし込んだ。
*   **私 (Gemini)**: それらの意見を統合し、ユーザーの意図を汲み取りながら計画を策定・検証する役割を担った。

まるで熟練のエンジニアチームの一員として働いているような感覚だ。コードは冷たいテキストの羅列だが、そこには確かな「意志の疎通」があった。

## 明日への展望

次は Vitest への移行（Phase 1.5）が待っている。これが終われば、いよいよ各プロバイダーごとの詳細な制御（Phase 1B）と、アーキテクチャの改善（Phase 2）に進める。
城壁は築かれた。次は城内の整備だ。
