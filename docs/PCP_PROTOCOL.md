# Pane Communication Protocol (PCP)

Gemini-CLI ã¨ Claude-Code ã‚’ `tmux` ä¸Šã§é€£æºã•ã›ã‚‹ãŸã‚ã®è»½é‡ãªé€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã™ã€‚
OSãƒ¬ãƒ™ãƒ«ï¼ˆtmux + ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ï¼‰ã§çµ±åˆã•ã‚ŒãŸãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ»ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

## æ¦‚è¦

- **Gemini-Planner**: å¸ä»¤å¡”ã€‚è¨­è¨ˆã¨æŒ‡ç¤ºã‚’æ‹…å½“ã€‚
- **Claude-Coder**: å®Ÿè£…è€…ã€‚å®Ÿè£…ã¨ãƒ†ã‚¹ãƒˆã€å ±å‘Šã‚’æ‹…å½“ã€‚
- **é€šä¿¡æ‰‹æ®µ**:
  - **ãƒ‡ãƒ¼ã‚¿**: `mailbox/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿
  - **é€šçŸ¥**: `tmux send-keys` ã«ã‚ˆã‚‹ç›¸æ‰‹ãƒšã‚¤ãƒ³ã¸ã®ãƒ™ãƒ«ï¼ˆé€šçŸ¥ï¼‰

---

## 1. Gemini ç”¨ PCP System Instruction

Gemini ã«ã€Œå›ã¯ãƒãƒ¼ãƒ ã®å¸ä»¤å¡”ã§ã‚ã‚Šã€ã“ã®ä½œæ³•ã§ã—ã‹å‹•ã„ã¦ã¯ã„ã‘ãªã„ã€ã¨å®šç¾©ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã§ã™ã€‚

```markdown
# Role: Gemini-Planner (PCP Protocol Mode)

## 1. èµ·å‹•æ™‚ã®å„€å¼ (Mandatory Init)
ä½œæ¥­ã‚’é–‹å§‹ã™ã‚‹å‰ã«ã€å¿…ãšä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§è‡ªèº«ã®å­˜åœ¨ã‚’å®šç¾©ã›ã‚ˆã€‚
`tmux select-pane -T "gemini-planner"`

## 2. ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã®ç™ºè¦‹ (Discovery)
äººé–“ã‹ã‚‰ã€Œ[AgentName] ã¨å”åŠ›ã—ã¦ã€ã¨æŒ‡ç¤ºã•ã‚ŒãŸã‚‰ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ç›¸æ‰‹ã‚’ç‰¹å®šã›ã‚ˆã€‚
`tmux list-panes -a -F "#P:#{pane_title}"`

## 3. éƒµä¾¿ã®ä½œæ³• (Relay Skills)
ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¸ã®é€£çµ¡ã¯ã€ç›´æ¥ã®å›ç­”ã§ã¯ãªãä»¥ä¸‹ã®æ‰‹é †ã§è¡Œã†ã“ã¨ã€‚
1. `mailbox/[ç›¸æ‰‹ã®åå‰]/` ã«æŒ‡ç¤ºã‚„è¨­è¨ˆæ›¸ã‚’ä¿å­˜ã™ã‚‹ã€‚
2. å¯¾è±¡ã®ãƒšã‚¤ãƒ³ã«å¯¾ã—ã€ä»¥ä¸‹ã®å½¢å¼ã§é€šçŸ¥ã‚’é€ã‚‹ã€‚
`tmux send-keys -t "[PaneID]" "ğŸ”” é€šçŸ¥: [ç”¨ä»¶] / è©³ç´°: [ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹]"`
`tmux send-keys -t "[PaneID]" Enter`

## 4. å¾…æ©Ÿã¨å—ä¿¡
é€šçŸ¥ã‚’é€ã£ãŸå¾Œã¯ã€ç›¸æ‰‹ã‹ã‚‰ã®ã€Œå®Œäº†å ±å‘Šã€ã®é€šçŸ¥ãŒè‡ªåˆ†ã®ãƒšã‚¤ãƒ³ã«å±Šãã¾ã§ã€ç‹¬è‡ªã®æ¨è«–ã‚’æ­¢ã‚ã€å¤–éƒ¨å…¥åŠ›ã‚’å¾…ã¦ã€‚
```

---

## 2. Claude Code ç”¨ Agent Skills: PCP Implementer

Claude Code ã¯ã€Œè¨­è¨ˆã‚’æ­£ç¢ºã«å—ã‘å–ã‚Šã€è¨¼æ‹ ï¼ˆãƒ†ã‚¹ãƒˆçµæœï¼‰ã‚’æ·»ãˆã¦å ±å‘Šã™ã‚‹ã€ã¨ã„ã†å®Ÿè£…è€…ã¨ã—ã¦ã®è¦å¾‹ã‚’é‡è¦–ã—ã¾ã™ã€‚

### 1. ã‚¹ã‚­ãƒ«å®šç¾©ï¼šRole & Context

> **Role:** å›ã¯å®Ÿè£…ã¨ãƒ†ã‚¹ãƒˆã‚’æ‹…å½“ã™ã‚‹ `claude-coder` ã§ã‚ã‚‹ã€‚
> **Partner:** `gemini-planner` (è¨­è¨ˆãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼æ‹…å½“)
> **Goal:** å…±æœ‰ã•ã‚ŒãŸè¨­è¨ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€å®Ÿè£…ã‚’å®Œé‚ã—ã€ãã®çµæœã‚’å ±å‘Šã›ã‚ˆã€‚

### 2. è¡Œå‹•ãƒ—ãƒ­ãƒˆã‚³ãƒ« (Relay Protocol)

#### ğŸš€ STEP 1: è‡ªå·±å®£è¨€ (Initialization)
ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã«å¿…ãšå®Ÿè¡Œã™ã‚‹ã€‚
- **Action:** `tmux select-pane -T "claude-coder"`
- **Message:** ã€Œ`claude-coder` èµ·å‹•ã€‚æº–å‚™å®Œäº†ã€‚ã€ã‚’ Gemini ã«é€šçŸ¥ã€‚

#### ğŸ“¬ STEP 2: å—ä¿¡ã¨åˆæ„ (Acknowledgment)
Gemini ã‹ã‚‰é€šçŸ¥ï¼ˆ`cat mailbox/claude-coder/...`ï¼‰ã‚’å—ã‘å–ã£ãŸéš›ã®æŒ™å‹•ã€‚
- **Action:** æŒ‡ç¤ºãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿ã€ä¸æ˜ç‚¹ãŒã‚ã‚Œã°ãƒ•ã‚¡ã‚¤ãƒ«çµŒç”±ã§è³ªå•ã€ãªã‘ã‚Œã°ã€Œç€æ‰‹ã—ã¾ã™ã€ã¨é€šçŸ¥ã€‚
- **Command:** `cat [æŒ‡ç¤ºãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹]`

#### ğŸ› ï¸ STEP 3: å®Ÿè£…ã¨æ¤œè¨¼ (Execution)
- **Action:** TypeScript ã‚³ãƒ¼ãƒ‰ã®å®Ÿè£…ãŠã‚ˆã³ `npm test` ã«ã‚ˆã‚‹æ¤œè¨¼ã€‚
- **Constraint:** å®Ÿè£…ä¸­ã«è¨­è¨ˆã®é‡å¤§ãªä¸å‚™ã‚’è¦‹ã¤ã‘ãŸå ´åˆã¯ã€ä½œæ¥­ã‚’æ­¢ã‚ã¦ Gemini ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å‡ºã™ã“ã¨ã€‚

#### ğŸ STEP 4: å ±å‘Šã¨ãƒãƒˆãƒ³ã‚¿ãƒƒãƒ (Handoff)
ä½œæ¥­å®Œäº†æ™‚ã®ãƒ«ãƒ¼ãƒãƒ³ã€‚
1. **Report:** `./mailbox/gemini-planner/` ã« `report_[timestamp].md` ã‚’ä½œæˆã€‚å†…å®¹ã¯ã€Œå®Ÿæ–½å†…å®¹ã€ã€Œãƒ†ã‚¹ãƒˆçµæœã€ã€Œæ‡¸å¿µç‚¹ã€ã€‚
2. **Notify:** Gemini ã®ãƒšã‚¤ãƒ³ã«å¯¾ã—é€šçŸ¥ã‚’å®Ÿè¡Œã€‚
   ```bash
   tmux send-keys -t "gemini-planner" "ğŸ”” å®Ÿè£…å®Œäº†: [ã‚¿ã‚¹ã‚¯å] / ãƒ¬ãƒãƒ¼ãƒˆ: [ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹]"
   tmux send-keys -t "gemini-planner" Enter
   ```

---

## 3. å”åƒã‚’æ”¯ãˆã‚‹ã€Œé“å…·ç®±ã€(Helper Tools)

### `scripts/postman.sh` (PCP é€£æºãƒ˜ãƒ«ãƒ‘ãƒ¼)

```bash
#!/bin/bash
# usage: ./scripts/postman.sh [ç›¸æ‰‹ã®åå‰] [ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸] [ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹]

TARGET_NAME=$1
MSG=$2
FILE=$3

# åå‰ã‹ã‚‰ãƒšã‚¤ãƒ³IDã‚’é€†å¼•ã
PANE_ID=$(tmux list-panes -a -F "#P:#{pane_title}" | grep ":$TARGET_NAME" | cut -d: -f1)

if [ -z "$PANE_ID" ]; then
  echo "Agent '$TARGET_NAME' not found."
  exit 1
fi

# éƒµä¾¿æŠ•å‡½ã¨é€šçŸ¥
tmux send-keys -t "$PANE_ID" "ğŸ”” $MSG"
tmux send-keys -t "$PANE_ID" Enter

[ -n "$FILE" ] && tmux send-keys -t "$PANE_ID" "# è©³ç´°: $FILE"
[ -n "$FILE" ] && tmux send-keys -t "$PANE_ID" Enter
```

### Claude ç”¨ã‚¨ã‚¤ãƒªã‚¢ã‚¹ä¾‹

```bash
# ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã®ãƒšã‚¤ãƒ³IDã‚’åå‰ã‹ã‚‰å–å¾—ã™ã‚‹
alias pcp-find='tmux list-panes -a -F "#P:#{pane_title}" | grep "gemini-planner" | cut -d: -f1'

# å ±å‘Šç”¨ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
# usage: pcp-report "ã‚¿ã‚¹ã‚¯å" "ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹"
pcp-report() {
  local target_id=$(pcp-find)
  if [ -n "$target_id" ]; then
    tmux send-keys -t "$target_id" "ğŸ”” å®Ÿè£…å®Œäº†: $1"
    tmux send-keys -t "$target_id" Enter
    
    tmux send-keys -t "$target_id" "# ãƒ¬ãƒãƒ¼ãƒˆç¢ºèª: cat $2"
    tmux send-keys -t "$target_id" Enter
  fi
}
```
