# テスト戦略

このドキュメントでは、`agent-factory-mcp` におけるテスト戦略、テストの種類、実行方法、および特定の設計判断（AutoDiscovery など）の背後にある根拠について説明します。

## 概要

本プロジェクトでは、速度と信頼性（ユニットテスト）と、実環境での動作保証（E2Eテスト）のバランスを取るために、**ハイブリッドテスト戦略**を採用しています。

| テスト種別 | スコープ | 依存関係 | 速度 | 目的 |
| :--- | :--- | :--- | :--- | :--- |
| **ユニットテスト** | ロジックの正当性 (Parser, Config, Registry) | なし (Fixturesを使用) | 高速 (数秒) | コードロジックの検証、デグレード防止。 |
| **E2Eテスト** | システム全体の統合 (Discovery -> 実行) | 実際の AI CLI ツール | 低速 (10秒〜) | 実際のバイナリと連携して動作することの保証。 |

## テストコマンド

本プロジェクトはテストランナーに **Vitest** を採用しています。
タスクランナー [Task](https://taskfile.dev/) または `npm`/`bun` スクリプトを使用して実行します。

| コマンド | `npm` 等価 | 説明 | 推奨される用途 |
| :--- | :--- | :--- | :--- |
| `task test-unit` | `npm run test:unit` | E2E以外のすべてのテスト (`test/**/*.test.ts`) を実行。 | **開発時のメイン。** ロジック修正時に頻繁に実行。 |
| `task test-e2e` | `npm run test:e2e` | E2Eテスト (`test/e2e-ai-flow.test.ts`) のみを実行。 | リリース前や、環境構築後の疎通確認。 |
| `task check` | - | 型チェック -> Lint -> ユニットテストを実行。 | **CI/コミット前。** 外部依存なしで品質を担保。 |
| `task test` | `npm test` | 全テスト (Unit + E2E) を実行。 | すべての環境が整っている状態での最終確認。 |

## 戦略的判断

### AutoDiscovery とハイブリッドアプローチ

**AutoDiscovery（自動検出）** 機能は、ユーザーのローカル環境（`PATH` に何がインストールされているか、どのバージョンか）に強く依存するため、テストが難しいという課題があります。

1.  **すべてをモック化しない理由**
    *   ファイルシステムや `exec` 呼び出しをすべてモック化すると、テストは通るのに「実環境では動かない（ツールの出力形式が変わった、権限がない等）」という事態を防げないためです。
2.  **すべてを E2E にしない理由**
    *   外部バイナリの呼び出しは遅く、また特定のツール（`claude`, `gemini`等）がインストールされていない環境（CIなど）でテストが失敗してしまうためです。

**解決策：**
以下の2層構造でテストを構成しています。

*   **レイヤー 1: 決定論的なパース検証 (ユニットテスト)**
    *   対象: `src/parsers/help-parser.ts`
    *   方法: 実際のツールのヘルプ出力 (`--help`) をテキストファイル (`test/fixtures/*.txt`) として保存。
    *   テスト: 保存されたテキストを正しくパースしてメタデータを生成できるかを検証。これはどこでも高速に実行可能です。

*   **レイヤー 2: 実環境での疎通確認 (E2Eテスト)**
    *   対象: `src/utils/autoDiscovery.ts`, `src/providers/*`
    *   方法: 実際に `discoverCompatibleTools()` を呼び出し、見つかったツールに対して `--version` などの無害なフラグを実行。
    *   テスト: パイプライン全体が現在の環境で機能することを証明します。

## CI/CD ワークフロー

GitHub Actions では `task check`（内部で `test:unit` を実行）を使用しています。
これにより：
1.  **CIが環境に左右されない**: 実行環境に AI ツールがなくてもテストが失敗しません。
2.  **ロジックの検証を徹底**: マージ前にコードの論理的な正しさを常に保証します。
3.  **E2Eはローカルで**: 実際のツールが必要な検証は、開発者の手元や専用の環境で行う運用としています。