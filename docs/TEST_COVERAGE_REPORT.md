# Test Coverage Report

**Generated:** 2026-01-26
**Repository:** Agent Factory MCP
**Commit:** N/A (Local Development)

---

## Overview
This report summarizes the **test structure, coverage setup, and recommendations** for the Agent Factory MCP project. It provides a detailed analysis of the current testing practices, identifies gaps, and suggests actionable improvements.

---

## 1. Test Structure and Organization

### Directory Layout
```
test/
├── base-cli.provider.test.ts       # Unit tests for BaseCliProvider
├── autoDiscovery.test.ts           # Integration tests for auto-discovery
├── e2e-ai-flow.test.ts             # End-to-end integration test
├── configLoader.test.js            # Unit tests for ConfigLoader
├── help-parser.test.js             # Unit tests for HelpParser
├── registry.test.js                # Unit tests for Tool Registry
├── subcommands.test.js             # Unit tests for CLI subcommand parsing
├── system-prompt.test.js           # Unit tests for system prompt generation
├── tools.test.js                   # Unit tests for simple tools
└── fixtures/                       # Test fixtures (CLI help outputs, etc.)
    ├── qwen-help.txt
    ├── ollama-help.txt
    └── CLAUDE.md
```

### Test Types
| Type | Description | Example Files |
|------|-------------|---------------|
| **Unit Tests** | Fast, deterministic tests for individual modules | `configLoader.test.js`, `help-parser.test.js`, `registry.test.js` |
| **Integration Tests** | Tests for interactions between modules | `autoDiscovery.test.ts` |
| **End-to-End (E2E) Tests** | Full-system tests requiring real CLI tools | `e2e-ai-flow.test.ts` |

### Test Frameworks
- **Primary:** [Bun Test Runner](https://bun.sh/docs/cli/test) (`bun:test`)
- **Secondary:** Node.js built-in test runner (`node:test`)
- **Assertions:**
  - Bun: `expect` (e.g., `expect(result).toBe(true)`)
  - Node: `assert` (e.g., `assert.strictEqual(result, expected)`)

### Test Scripts (`package.json`)
```json
{
  "scripts": {
    "test": "bun test test/**/*.test.{js,ts}",
    "test:unit": "bun test test/**/*.test.{js,ts} --ignore test/e2e-ai-flow.test.ts",
    "test:e2e": "bun test test/e2e-ai-flow.test.ts"
  }
}
```

---

## 2. Test Coverage

### Current State
- **No coverage tooling is configured** in the repository.
- **No coverage reports** are generated by default.
- **No coverage thresholds** are enforced.

### Coverage Gaps
| Module | Coverage Status | Notes |
|--------|------------------|-------|
| `src/providers/base-cli.provider.ts` | ❌ Untested | Critical module for all CLI tool interactions |
| `src/providers/generic-cli.provider.ts` | ❌ Untested | Core provider for dynamic tool execution |
| `src/tools/dynamic-tool-factory.ts` | ❌ Untested | Dynamic MCP tool generation |
| `src/parsers/help-parser.ts` | ✅ Tested | Unit tests exist in `help-parser.test.js` |
| `src/utils/configLoader.ts` | ✅ Tested | Unit tests exist in `configLoader.test.js` |
| `src/utils/autoDiscovery.ts` | ✅ Tested | Integration tests exist in `autoDiscovery.test.ts` |

### Coverage Recommendations
#### **Option 1: Bun Built-in Coverage (Recommended)**
- **Pros:** No extra dependencies; aligns with existing Bun workflow.
- **Cons:** Limited threshold enforcement.

**Steps to Enable:**
1. Add coverage scripts to `package.json`:
   ```json
   {
     "scripts": {
       "coverage": "bun test --coverage",
       "coverage:unit": "bun test --coverage test/**/*.test.{js,ts} --ignore test/e2e-ai-flow.test.ts"
     }
   }
   ```
2. Run locally:
   ```bash
   bun run coverage
   ```
3. Generate HTML report:
   ```bash
   bun run coverage --coverage-reporter=html
   ```
   - Report location: `coverage/html/index.html`.

4. Update CI to include coverage:
   ```yaml
   # .github/workflows/ci.yml
   - name: Run coverage
     run: bun run coverage:unit
   ```

#### **Option 2: NYC (Istanbul) Coverage**
- **Pros:** Mature tooling; supports thresholds and detailed reports.
- **Cons:** Adds Node.js dependency.

**Steps to Enable:**
1. Install NYC:
   ```bash
   bun add -d nyc
   ```
2. Add NYC config to `package.json`:
   ```json
   {
     "nyc": {
       "reporter": ["lcov", "text", "html"],
       "extension": [".ts", ".js"],
       "include": ["src/**/*"],
       "exclude": ["src/**/*.test.{ts,js}"],
       "check-coverage": true,
       "lines": 80,
       "functions": 70,
       "branches": 70
     }
   }
   ```
3. Add coverage script:
   ```json
   {
     "scripts": {
       "coverage": "nyc bun test test/**/*.test.{js,ts}"
     }
   }
   ```
4. Run locally:
   ```bash
   bun run coverage
   ```

---

## 3. CI/CD Integration

### Current CI Workflow
- **GitHub Actions:** Runs lint, build, and unit tests (via `task check`).
- **No coverage reporting** in CI.

### Recommended CI Updates
1. **Add coverage step** to `.github/workflows/ci.yml`:
   ```yaml
   - name: Run coverage
     run: bun run coverage:unit
   ```

2. **Upload coverage reports** (optional):
   ```yaml
   - name: Upload coverage to Codecov
     uses: codecov/codecov-action@v3
     with:
       file: ./coverage/lcov.info
   ```

3. **Enforce thresholds** (optional):
   ```yaml
   - name: Check coverage thresholds
     run: bun run coverage:unit && npx check-coverage --lines 80
   ```

---

## 4. Test Improvements

### Critical Modules to Test
| Module | Priority | Notes |
|--------|----------|-------|
| `src/providers/base-cli.provider.ts` | ⭐⭐⭐⭐⭐ | Base class for all providers; currently untested |
| `src/providers/generic-cli.provider.ts` | ⭐⭐⭐⭐⭐ | Core provider for dynamic tool execution |
| `src/tools/dynamic-tool-factory.ts` | ⭐⭐⭐⭐ | Dynamic MCP tool generation |
| `src/utils/commandExecutor.ts` | ⭐⭐⭐ | CLI command execution with timeouts |

### Test Patterns to Adopt
1. **Mocking:** Introduce a lightweight mocking utility for common interfaces (e.g., `AIProvider`).
2. **Fixtures:** Standardize fixture loading (e.g., `loadFixture("qwen-help.txt")`).
3. **Setup/Teardown:** Use `beforeEach`/`afterEach` for test isolation.
4. **Deterministic Tests:** Avoid real CLI tools in unit tests; use fixtures or mocks.

### Example: Testing `BaseCliProvider`
```typescript
import { describe, it, expect, beforeEach } from "bun:test";
import { BaseCliProvider } from "../../src/providers/base-cli.provider";
import type { CliToolMetadata } from "../../src/types/cli-metadata";

class TestCliProvider extends BaseCliProvider {
  id = "test-provider";

  getMetadata(): CliToolMetadata {
    return {
      name: "test-tool",
      command: "echo",
      description: "A test tool",
      args: [],
      flags: {},
    };
  }

  async execute(args: Record<string, any>): Promise<string> {
    return "Test output";
  }
}

describe("BaseCliProvider", () => {
  let provider: TestCliProvider;

  beforeEach(() => {
    provider = new TestCliProvider();
  });

  it("should implement AIProvider interface", () => {
    expect(provider.id).toBe("test-provider");
    expect(provider.getMetadata()).toEqual({
      name: "test-tool",
      command: "echo",
      description: "A test tool",
      args: [],
      flags: {},
    });
  });
});
```

---

## 5. Documentation Updates

### Update `docs/TESTING.md`
Add the following sections:
1. **Coverage Setup**
   - How to run coverage locally (`bun run coverage`).
   - How to generate HTML reports.
   - Coverage thresholds (if enforced).

2. **CI/CD Integration**
   - How coverage is measured in CI.
   - How to view coverage reports.

3. **Test Patterns**
   - Mocking strategies.
   - Fixture usage.
   - Setup/teardown best practices.

---

## 6. Summary of Recommendations

| Area | Recommendation | Priority |
|------|----------------|----------|
| **Coverage Tooling** | Enable Bun built-in coverage | ⭐⭐⭐⭐⭐ |
| **Critical Modules** | Add tests for `base-cli.provider.ts`, `generic-cli.provider.ts`, `dynamic-tool-factory.ts` | ⭐⭐⭐⭐⭐ |
| **CI Integration** | Add coverage step to GitHub Actions | ⭐⭐⭐⭐ |
| **Documentation** | Update `docs/TESTING.md` with coverage and test patterns | ⭐⭐⭐ |
| **Test Patterns** | Standardize mocking and fixture usage | ⭐⭐⭐ |

---

## 7. Next Steps
1. **Enable coverage** (Bun or NYC).
2. **Add tests for critical modules**.
3. **Update CI workflow** to include coverage.
4. **Document the testing strategy** in `docs/TESTING.md`.